<!DOCTYPE html>
<html lang="en">
    <!-- IMPLEMENT SERVER SIDE LOADING OF TABLE -->
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.css">
        
    </head>

    <div id="page">
        <h1>Support Tickets</h1>
        <body>
            <table id="data" border class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">Ticket ID</th>
                        <th scope="col">User ID</th>
                        <th scope="col">Message</th>
                        <th scope="col">Date Received(EST)</th>
                        <th scope="col">Date Closed(EST)</th>
                        <th scope="col">Reply</th>
                        <th scope="col">Close Ticket</th>

                    </tr>
                </thead>
                <tbody>
                    <!-- {% for ticket in tickets%}
                        <tr>
                            <td>{{ticket.ticket_id}}</td>
                            <td>{{ticket.user_id}}</td>
                            <td>{{ticket.message}}</td>
                            <td>{{ticket.date_received}}</td>
                            <td>{{ticket.date_ticket_closed}}</td>
                            <td>
                                <form action="/admin/reply" method="post">
                                    <button type="submit" name ="selected_user_id" value="{{ticket.user_id}}">Reply to this ticket</button>
                                    <input type="hidden" name="selected_ticket_id" value="{{ticket.ticket_id}}">
                                </form>
                            </td>
                            <td>
                                <form action="/admin/close_ticket" method="post">
                                    <button type="submit" name ="selected_ticket_id" value="{{ticket.ticket_id}}">Close Ticket</button>
                                </form>
                            </td>
                        </tr>
                    {%endfor%} -->
                </tbody> 
            </table>

            <div class="d-flex flex-column justify-content-center">
                <button class="btn btn-primary btn-lg" type="button" onclick="location.href='/admin'"> Back</button>
            </div>
            <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
            <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.js"></script>
            <script>
                $(document).ready(function () {
                    var table = $('#data').DataTable({
                        ajax: '/admin/support_tickets/data',
                        columns: [
                            {data: 'ticket_id'},
                            {data: 'user_id'},
                            {data: 'message', orderable: false, searchable: false},
                            {data: 'date_received'},
                            {data: 'date_ticket_closed'},
                            {data: null, defaultContent: '<button class=replyButton>Reply</button>', orderable: false, searchable: false},
                            {data: null, defaultContent: '<button class=closeTicket>Close Ticket</button>', orderable: false, searchable: false}
                        ]
                    });

                    $('#data tbody').on('click', 'button.replyButton', function () {
                        var data = table.row($(this).parents('tr')).data();
                        replyToTicket(data);
                    });

                    $('#data tbody').on('click', 'button.closeTicket', function () {
                        var data = table.row($(this).parents('tr')).data();
                        closeTicket(data);
                    });
                });

                function replyToTicket(rowData) {
                    $.ajax({
                        url: "/admin/reply",
                        type: "POST",
                        data: {
                            selected_user_id: rowData.user_id,
                            selected_ticket_id: rowData.ticket_id
                            // Add other properties as needed
                        },
                        success: function(response) {
                            // Handle success response
                            console.log('replying to ticket');
                            $("#page").html(response);
                        },
                        error: function(error) {
                            // Handle error
                            console.error(error);
                        }
                    });
                }

                function closeTicket(rowData) {
                    $.ajax({
                        url: "/admin/close_ticket",
                        type: "POST",
                        data: {
                            selected_ticket_id: rowData.ticket_id
                        },
                        success: function(response) {
                            // Handle success response
                            console.log('closing ticket');
                            $("#page").html(response);
                        },
                        error: function(error) {
                            // Handle error
                            console.error(error);
                        }
                    });
                }
            </script>
        </body>
        </div>
</html>

